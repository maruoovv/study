## 맵리듀스

맵리듀스는 데이터 처리를 위한 프로그래밍 모델이다.  
맵리듀스는 병행성을 고려하여 설계되었고, 충분한 장비만 갖추고 있다면 대규모 데이터 분석을 할 수 있다.

### 하둡으로 데이터 분석하기 

#### 맵과 리듀스 

맵리듀스 작업은 크게 맵 단계와 리듀스 단계로 구분된다. 각 단계는 입력과 출력으로 키-값의 쌍을 가진다.

#### 맵리듀스 

맵리듀스 **잡** 은 클라이언트가 수행하는 작업이 기본 단위다.  
잡은 입력 데이터, 맵리듀스 프로그램, 설정 정보로 구성된다.  
하둡은 잡을 **맵 태스크** 와 **리듀스 태스크** 로 나누어 실행한다.  
각 태스크는 YARN 을 이용하여 스케줄링되고 클러스터의 여러 노드에서 실행된다.  
특정 노드의 태스크 하나가 실패하면 자동으로 다른 노드를 재할당 하여 다시 실행된다.  

##### 스플릿 

하둡은 맵리듀스 잡의 입력을 **스플릿** 이라고 부르는 고정 크기 조각으로 분리한다.  
각 스플릿마다 하나의 맵 태스크를 생성하고 스플릿의 각 레코드를 사용자 정의 맵 함수로 처리한다.  

스플릿을 병렬로 처리하면 고성능 서버가 많은 스플릿을 처리할 수 있기 때문에 스플릿의 크기가 작을수록 부하 분산에 좋은 효과를 볼 수 있다.  
반면 스플릿 크기가 너무 작으면 스플릿 관리와 맵 태스크 생성을 위한 오버헤드 때문에 잡의 실행 시간이 증가하는 단점이 있다.  
일반적으로 스플릿 크기는 HDFS 의 블록 기본 크기인 128MB 가 적당하다고 알려져 있다.  

##### 데이터 지역성 최적화

HDFS 내의 입력 데이터가 있는 노드에서 맵 태스크를 실행할 때 가장 빠르게 작동한다.  
이를 **데이터 지역성 최적화** 라고 하는데, 클러스터의 중요한 공유 자원인 네트워크 대역폭을 사용하지 않는 방법이다.  
하지만 입력 스플릿에 해당하는 HDFS 블록 복제본이 저장된 노드 모두 여유가 없는 상황이 발생할 수 있다.    
이런 경우 잡 스케줄러는 블록 복제본이 저장된 동일 랙에 속한 다른 노드나, 매우 드물지만 외부 랙의 노드가 선택 될 경우도 존재한다.
  
![image](https://user-images.githubusercontent.com/37106689/76162111-8ea1dc00-617d-11ea-90d1-0b330615759e.png)

A : 입력 데이터가 있는 노드에서 맵 태스크 실행  
B : 입력 데이터가 있는 노드가 저장된 동일 랙에 다른 노드에서 맵 태스크 실행   
C : 다른 랙의 다른 노드에서 맵 태스크 실  

##### 맵 태스크 
맵 태스크의 결과는 HDFS 가 아닌 로컬 디스크에 저장된다. 맵의 결과는 리듀스가 최종 결과를 생성하기 위한 중간 결과물이고, 잡이 완료된 후 맵의 결과는 그냥 버려진다.  
따라서 맵의 결과를 HDFS 에 저장하는 것은 적절치 않다. 리듀스 태스크로 모든 결과를 보내기 전에 맵 태스크가 실패한다면 자동으로 맵 태스크를 다른 노드에 할당하여 재시작한다.  

##### 리듀스 태스크 
리듀스 태스크는 일반적으로 모든 매퍼의 출력 결과를 입력으로 받기 때문에 데이터 지역성의 장점이 없다.  
일반적으로 리듀스의 결과는 안정성을 위해 HDFS 에 저장된다.  

![image](https://user-images.githubusercontent.com/37106689/76162229-0290b400-617f-11ea-844a-05333cc062dc.png)


리듀스 태스크 수는 입력 크기와 상관없이 독립적으로 지정할 수 있다.  
리듀스가 여러개이면 맵 태스크는 리듀스 수만큼 파티션을 생성하고 맵의 결과를 각 파티션에 분배한다.

![image](https://user-images.githubusercontent.com/37106689/76162295-c6aa1e80-617f-11ea-82dc-11b2b4e44cb3.png)


리듀스 태스크가 아예 없을 수도 있는데, 셔플이 필요 없고 모든 처리 과정을 완전히 병렬로 처리하는 경우에 적합하다.  


#### 컴바이너 함수  
맵리듀스 잡이 사용하는 네트워크 대역폭은 한계가 있기 때문에 맵과 리듀스 태스크 사이의 데이터 전송을 최소화 할 필요가 있다.  
하둡은 맵의 결과를 처리하는 **컴바이너 함수** 를 제공한다.  하둡은 컴바이너 함수의 호출 빈도와 상관 없이 리듀스의 결과가 언제나 같도록 보장한다.  
컴바이너 함수에 적용할 수 있는 함수의 형태에는 제약이 있다. 또한 컴바이너 함수가 리듀스 함수를 완전히 대체할 수도 없다.

### 하둡 스트리밍
하둡은 자바 외에 다른 언어로 맵과 리듀스 함수를 작성할 수 있는 맵리듀스 API를 제공한다.  
**하둡 스트리밍**은 하둡과 사용자 프로그램 사이의 인터페이스로 유닉스 표준 스트림을 사용한다.
