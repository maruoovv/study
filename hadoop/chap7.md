## 맵리듀스 작동 방법

### 맵리듀스 잡 실행 상세분석 
하둡이 맵리듀스 잡을 실행하는 과정을 알아보자.  




상위 수준에서 보면 다섯 개의 독립적인 단계로 구분된다.

- 클라이언트 : 맵 리듀스 잡을 제출한다.
- YARN 리소스 매니저 : 클러스터 상에 계산 리소스의 할당을 제어한다.
- YARN 노드 매니저 : 클러스터의 각 머신에서 계산 컨테이너를 시작하고 모니터링한다.
- 맵리듀스 애플리케이션 마스터 : 맵리듀스 잡을 수행하는 각 태스크를 제어한다. 
- 분산 파일 시스템 : 다른 단계 간에 잡 리소스 파일들을 공유하는데 사용된다.

#### 잡 제출
잡을 제출하면 waitForCompletion() 메서드가 1초에 한 번씩 잡의 진행 상황을 조사하여 변경 내역을 콘솔로 보여준다.  
잡 제출 과정은 다음과 같다.

1. 리소스 매니저에 맵리듀스 잡 ID로 사용할 애플리케이션 ID 요청 (2)
2. 잡의 출력 명세를 확인하고 문제가 있을 시 에러 전달.
3. 잡의 입력 스플릿을 계산. 계산할 수 없다면 에러 전달.
4. 잡 실행에 필요한 JAR, 환경설정 파일, 입력 스플릿 등 리소스를 공유 파일시스템에 있는 해당 잡 ID 를 이름으로 하는 디렉터리에 복사. (3)
5. 리소스 매니저의 submitApplication 을 호출하여 잡 제출 (4)

#### 잡 초기화
리소스 매니저가 submitApplication 호출을 받으면 YARN 스케줄러에 요청을 전달한다.  
스케줄러는 컨테이너를 할당하고 애플리케이션 마스터 프로세스를 시작한다. (5a, 5b)

애플리케이션 마스터는 잡을 초기화할 때 잡의 진행 상태를 추적하기 위한 다수의 북키핑 객체를 생성하고, 각 태스크로부터 진행 및 종료 보고서를 받는다(6)  
다음으로 클라이언트가 계산한 입력 스플릿 정보를 공유 파일 시스템에서 읽어온다. (7)  
이후 입력 스플릿별로 맵 태스크 객체를 생성하고, 리듀스 객체를 생성한다.  

잡의 크기가 작다면 애플리케이션 마스터는 태스트를 자신의 JVM에서 실행할 수 있다.  
이러한 잡을 **우버 태스크** 또는 **우버되었다(uberized)** 라 한다.  
이런 일이 일어날 경우는, 병렬 처리를 위한 오버헤드 보다, 단일 노드에서 순차적으로 실행하는 것이 유리하다고 판단될 때다.  
우버 태스크를 활성화 하려면 반드시 mapreduce.job.ubertask.enable 속성을 true 로 해야한다.

#### 태스크 할당 
애플리케이션 마스터는 리소스 매니저에 잡의 모든 맵, 리듀스 태스크를 위한 컨테이너를 요청한다. (8)  
맵 태스크 요청이 리듀스 보다 우선순위가 높다. 리듀스의 정렬 단계 시작 전에 모든 맵 태스크가 완료되어야 하기 때문이다.  

리듀스 태스크는 클러스터의 어느 곳에서든 실행될 수 있지만, 맵 태스크는 스케줄러가 준수하는 데이터 지역성 제약이 있다. (데이터 로콜>랙 로컬)

#### 태스크 실행 
리소스가 태스크에 할당되면, 애플리케이션 마스터는 노드 매니저와 통신하며 컨테이너를 시작한다. (9a, 9b)  
각 태스크는 YarnChild 메인 클래스를 가진 자바 Application 으로 실행된다.  
태스크를 실행하기 전에 잡 환경 설정, JAR파일, 분산 캐시 파일 등 필요한 리소스를 로컬로 가져온 후, 맵과 리듀스 태스크를 실행한다.  

YarnChild는 별도 JVM에서 실행되기 떄문에, 맵, 류드스 함수에 버그가 발생하여도 노드매니저는 영향을 받지 않는다.

##### 스트리밍 
스트리밍 태스크는 표준 입출력 스트림을 통해 프로세스와 통신한다.  
태스크가 실행되는 동안 자바 프로세스는 키-값 쌍을 외부 프로세스에 전달하고, 이를 사용자 정의 맵/리듀스 함수로 처리한 뒤, 최종 출력 키-값 쌍을 자바 프로세스에 돌려준다.  
노드 매니저 관점에서는 자식 프로세스가 맵/리듀스 코드를 스스로 실행한 것처럼 보인다.

#### 진행 상황과 상태 갱신
맵리듀스 잡은 수행 시간이 오래 걸리므로, 사용자가 잡의 상황에 대해 피드백을 받는것은 매우 중요하다.  
잡과 개별 태스크는 상태, 맵/리듀스 진행 상황, 잡의 카운터 값, 상태 메시지 등의 상태 저보를 가진다.  
각 태스크는 자신의 진행 상황을 추적한다.  
맵과 리듀스 태스크는 실행되면서 부모인 애플리케이션 마스터와 통신한다. 진행상황과 상태 정보를 집계하여 인터페이스를 통해 마스터에 보고한다.  
잡이 진행되는 동안 클라이언트는 매초 마다 애플리케이션 마스터를 폴링하여 가장 최근의 상태를 받아온다.  

#### 잡 완료
애플리케이션 마스터가 마지막 태스크가 완료되었다는 통지를 받으면 잡의 상태를 '성공' 으로 변경한다.  
잡이 상태 정보를 폴링하면 해당 잡이 성공적으로 완료되었음을 알게 된다.
