## 관계형 데이터베이스 맵핑
데이터 원본 계층의 역할은 애플리케이션이 작업을 수행하는 데 필요한 인프라의 다양한 부분과 통신하는 것이다.  
이 계층에서 가장 중요한 일은 데이터베이스와 상호작용 하는 것이며, 일반적으로 관계형 데이터베이스를 의미한다.  

### 아키텍쳐 패턴

SQL 접근을 도메인 로직과는 별도로 분리하고 개별 클래스에 배치하는 것이 좋다.  
주로 데이터베이스 테이블당 클래스 하나를 가지도록 테이블 구조를 바탕으로 클래스를 구성하는 것이 좋다.  
이러한 클래스는 테이블에 대한 게이트웨이가 된다.  
애플리케이션의 나머지 부분에서는 SQL 에 대해 알 필요가 없고, 데이터베이스에 접근하는 SQL 을 쉽게 찾을 수 있다.  
설계에 도메인 모델이 있다면 O/R 맵핑 툴을 도입하는것도 고려해야 한다.  

### 동작 문제
ORM 을 활용할 때 가장 어려운 부분은 ORM 의 아키텍쳐와 동작 측면이다.  
다수의 객체를 메모리에 로드하고 수정 할 때는 객체를 데이터베이스에 올바르게 기록하기 위해 수정한 객체를 모두 추적해야 한다.  
객체를 읽고 수정하는 동안에는 사용하는 데이터베이스의 상태를 일관되게 유지해야 한다.  
그렇지 않으면 일관성 문제가 발생하고 잘못된 데이터가 저장될 수 있다.  

<b>작업단위</b> 는 위의 문제를 해결하는데 꼭 필요한 패턴이다.  
데이터베이스에서 읽은 객체를 다양한 방법으로 수정한 객체를 추적하고 데이터베이스를 업데이트한다.  
애플리케이션에서는 저장 메서드를 직접 호출하는 것이 아닌 작업 단위에 대해 커밋을 요청한다.  
작업단위가 없을 대는 일반적으로 도메인 계층이 컨트롤러 역할을 해서 데티어베이스를 읽고 쓸 시점을 결정한다. 

객체를 로드할 때는 같은 객체를 두번 로드하지 않게 주의해야 한다. 읽은 모든 행의 기록을 식별자 맵을 이용해 추적하면 이 문제를 예방할 수 있다.  
데이터를 읽을 때마다 먼저 식별자 맵을 이용해 이미 읽은 데이터인지 확인할 수 있다. 이미 읽은 데이터인 경우 이 데이터에 대한 참조를 반환하면 된다.  

도메인 모델을 사용할 때는 데이터베이스에서 객체를 로드할 때 연관된 객체가 함께 로드 되도록 하는 것이 일반적이다.  
그런데 여러 객체가 복잡하게 상호연결된 경우 어떤 객체를 읽더라도 데이터베이스에서 막대한 규모의 객체 그래프가 선택될 수 있다.  
이러한 비효율을 예방하려면 한번에 읽는 양을 줄이면서도 나중에 필요할 때 손쉽게 추가 데이터를 가져올 수 있는 방법이 필요하다.  
지연 로드는 객체 참조 대신 placeholder 를 이용하는 기법이다. 지연로드를 적절한 지점에 활용하면 데이터베이스에 대한 각 호출로 데이터를 필요한 만큼 가져올 수 있다. 

### 데이터 읽기 
데이터를 읽을 때는 성능 문제가 크게 다가올 수 있다. 이를 위해 경험에 근거한 몇 가지 규칙을 알아두자.  

- 가급적 여러 행을 한번에 읽는다. 특히 같은 테이블에서 여러 행을 읽기 위해 반복적으로 쿼리 하는 일이 없게 한다.  
- 조인을 사용해 쿼리 하나로 여러 테이블을 한 번에 가져온다. 조인을 너무 남발하면 오히려 성능이 저하되므로 주의한다.  
- 이 외에도 데이터 클러스터링, 인덱스 사용, 메모리 캐시 활용 등의 기법이 있을 수 있다.


### 데이터베이스 연결
대부분의 데이터베이스 인터페이스는 애플리케이션 코드와 데이터베이스 간의 링크 역할을 하는 데이터베이스 연결 객체를 사용한다.  
연결을 만드는 데 드는 비용을 절약하기 위해 연결 풀을 사용하는 경우가 많다. 개발자는 직접 연결을 만들고 닫는 대신 연결이 필요할 때 
풀에서 요청하며 작업이 끝나는 연결을 풀로 반환한다.  
연결을 만드는 비용은 크기 때문에 사용이 끝나면 즉시 반환해야 한다. 트랜잭션을 사용할 때는 일반적으로 특정 트랜잭션 내의 모든 명령을 동일한 연결에서 수행해야 한다.  


